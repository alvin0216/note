---
title: React 原理解析 - 任务调度
date: 2020-03-15 10:13:47
---

## 前言

`React16.5` 之后把 `scheduler` 单独发一个包了，就叫 `scheduler`。

**scheduler 能够把整个应用树更新的流程拆成每一个 fiber 为单元对象更新的流程，这种单元的形式拆分出来之后我们可以给每个不同的任务提供优先级以及我们在更新的过程当中，我们可以中断，因为我们可以记录我们更新到哪个单元，中断之后可以过一会再回过头来继续从这个单元开始之前没有做完的更新。**

> 为什么需要调度？

大家都知道 `JS` 和渲染引擎是一个互斥关系。如果 `JS` 在执行代码，那么渲染引擎工作就会被停止。假如我们有一个很复杂的复合组件需要重新渲染，那么调用栈可能会很长.

调用栈过长，再加上如果中间进行了复杂的操作，就可能导致长时间阻塞渲染引擎带来不好的用户体验，调度就是来解决这个问题的。

`React` 会根据任务的优先级去分配各自的 `expirationTime`，在过期时间到来之前先去处理更高优先级的任务，并且高优先级的任务还可以打断低优先级的任务（因此会造成某些生命周期函数多次被执行），从而实现在不影响用户体验的情况下去分段计算更新（也就是**时间分片**）

> React 如何实现调度

React 实现调度主要靠两块内容：

1. 计算任务的 `expriationTime`
2. 实现 `requestIdleCallback` 的 `polyfill` 版本
