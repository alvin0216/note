---
title: HTTP/2 有哪些改进
date: 2020-06-10 15:09:04
---

## 头部压缩

HTTP/1 里可以用头字段“Content-Encoding”指定 Body 的编码方式，比如用 gzip 压缩来节约带宽，但报文的另一个组成部分——Header 却被无视了，没有针对它的优化手段。

由于报文 Header 一般会携带“User Agent”“Cookie”“Accept”“Server”等许多固定的头字段，多达几百字节甚至上千字节，但 Body 却经常只有几十字节（比如 GET 请求、204/301/304 响应），成了不折不扣的“大头儿子”。更要命的是，成千上万的请求响应报文里有很多字段值都是重复的，非常浪费，“长尾效应”导致大量带宽消耗在了这些冗余度极高的数据上。

所以，HTTP/2 把“**头部压缩**”作为性能改进的一个重点，优化的方式你也肯定能想到，还是“压缩”。

不过 HTTP/2 并没有使用传统的压缩算法，而是开发了专门的“**HPACK**”算法，在客户端和服务器两端建立“字典”，用索引号表示重复的字符串，还釆用**哈夫曼编码**来压缩整数和字符串，可以达到 50%~90% 的高压缩率。

## 二进制分帧、多路复用、强化安全

你可能已经很习惯于 HTTP/1 里纯文本形式的报文了，它的优点是“一目了然”，用最简单的工具就可以开发调试，非常方便。

但 HTTP/2 在这方面没有“妥协”，决定改变延续了十多年的现状，不再使用肉眼可见的 ASCII 码，而是向下层的 TCP/IP 协议“靠拢”，全面采用二进制格式。

这样虽然对人不友好，但却大大方便了计算机的解析。原来使用纯文本的时候容易出现多义性，比如大小写、空白字符、回车换行、多字少字等等，程序在处理时必须用复杂的状态机，效率低，还麻烦。

而二进制里只有“0”和“1”，可以严格规定字段大小、顺序、标志位等格式，“对就是对，错就是错”，**解析起来没有歧义，实现简单，而且体积小、速度快，做到“内部提效”**。

**二进制分帧**

它把 TCP 协议的部分特性挪到了应用层，把原来的“Header+Body”的消息“打散”为数个小片的**二进制“帧”**（Frame），用“HEADERS”帧存放头数据、“DATA”帧存放实体数据。

这种做法有点像是“Chunked”分块编码的方式，也是“化整为零”的思路，但 HTTP/2 数据分帧后“Header+Body”的报文结构就完全消失了，协议看到的只是一个个的“碎片”。

![](https://static001.geekbang.org/resource/image/8f/96/8fe2cbd57410299a1a36d7eb105ea896.png)

消息的“碎片”到达目的地后应该怎么组装起来呢？

HTTP/2 为此定义了一个“**流**”（Stream）的概念，**它是二进制帧的双向传输序列**，同一个消息往返的帧会分配一个唯一的流 ID。你可以想象把它成是一个虚拟的“数据流”，在里面流动的是一串有先后顺序的数据帧，这些数据帧按照次序组装起来就是 HTTP/1 里的请求报文和响应报文。

**多路复用 解决队头阻塞问题**

因为“流”是虚拟的，实际上并不存在，所以 HTTP/2 就可以在一个 TCP 连接上用“流”同时发送多个“碎片化”的消息，这就是常说的“<span class='orange'>多路复用</span>”（ Multiplexing）——多个往返通信都复用一个连接来处理。

在“流”的层面上看，消息是一些有序的“帧”序列，而在“连接”的层面上看，消息却是乱序收发的“帧”。**多个请求 / 响应之间没有了顺序关系，不需要排队等待，也就不会再出现“<span class='orange'>队头阻塞</span>”问题，降低了延迟，大幅度提高了连接的利用率**。

![](https://static001.geekbang.org/resource/image/d8/bc/d8fd32a4d044f2078b3a260e4478c5bc.png)

为了更好地利用连接，加大吞吐量，HTTP/2 还添加了一些控制帧来管理虚拟的“流”，实现了优先级和流量控制，这些特性也和 TCP 协议非常相似。

**强化安全**

出于兼容的考虑，HTTP/2 延续了 HTTP/1 的“明文”特点，可以像以前一样使用明文传输数据，不强制使用加密通信，不过格式还是二进制，只是不需要解密。

## 服务器推送

HTTP/2 还在一定程度上改变了传统的“请求 - 应答”工作模式，服务器不再是完全被动地响应请求，也可以新建“流”主动向客户端发送消息。比如，在浏览器刚请求 HTML 的时候就提前把可能会用到的 JS、CSS 文件发给客户端，减少等待的延迟，这被称为“**服务器推送**”（Server Push，也叫 Cache Push）。

## 小结

- 头部压缩：减少传输体积，减小带宽消耗
- 二进制分帧：将明文传输变成二进制分帧，强化了传输安全
  - 多路复用：用“流”传输二进制帧，无序传输提高效率，解决队头阻塞问题
- 服务器推送

## 思考题

### 你觉得明文形式的 HTTP/2（h2c）有什么好处，应该如何使用呢？

明文就是没加密，没加密就不会有加密的开销，性能会好一些。

二进制的传输： 二进制用位来表示，含义清楚，没有纯文本大小写的模糊、歧义，解析起来效率高，而且二进制也更省空间。

### 你觉得应该怎样理解 HTTP/2 里的“流”，为什么它是“虚拟”的？

流是虚拟的，数据可以双向流动，因为流实际上只是个数字编号，只要是同一个编号的帧就可以认为属于一个流，那么数据双向也就可以理解了。

### 既然在连接层，是无序的，那在 http/2 中是怎么保证 frame 的有序性的呢？

tcp 层是有序的，所以一个流里的多个帧会按照顺序依次到达，接收方只要依次接收就可以了。
