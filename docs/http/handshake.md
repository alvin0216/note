---
title: HTTP 三次握手
date: 2020-03-29 22:29:18
---

## TCP 三次握手动画图

:::details 点击查看动画图
![](../../assets/http/shakeHands.gif)
:::

在学习之前，我们先捋一捋 HTTP 请求与 TCP 链接之间的关系。

在客户端向服务端请求和返回的过程中，是需要去创建一个 `TCP connection`，**因为 HTTP 是不存在链接这样一个概念的，它只有请求和响应这样一个概念**，请求和响应都是一个数据包，中间要通过一个传输通道，这个传输通道就是在 TCP 里面创建了一个从客户端发起和服务端接收的一个链接，TCP 链接在创建的时候是有一个三次握手(三次网络传输)这样一个消耗在的。

所谓三次握手(`Three-way Handshake`)，是指建立一个 `TCP` 连接时，需要客户端和服务器总共发送 3 个包。

## TCP 报文

TCP 报文是 TCP 层传输的数据单元，也叫报文段。

![](../../assets/http/tcp-msg.png)

1. 序号（`sequence number）`: Seq 序号，占 32 位，用来标识从 TCP 源端向目的端发送的字节流，发起方发送数据时对此进行标记。
2. 确认号（`acknowledgement number`）：Ack 序号，占 32 位，只有 ACK 标志位为 1 时，确认序号字段才有效，`Ack=Seq+1`。
3. 标志位：共 6 个，即 URG、ACK、PSH、RST、SYN、FIN 等，具体含义如下
   - `URG`：紧急指针（urgent pointer）有效。
   - `ACK`：确认序号有效。
   - `PSH`：接收方应该尽快将这个报文交给应用层。
   - `RST`：重置连接。
   - `SYN`：发起一个新连接。
   - `FIN`：释放一个连接。

::: warning 需要注意的是

1. 不要将确认序号 Ack 与标志位中的 ACK 搞混了。
2. 确认方 Ack=发起方 Req+1，两端配对。

:::

## 三次握手

三次握手的目的是连接服务器指定端口，建立 TCP 连接,并同步连接双方的序列号和确认号并交换 TCP 窗口大小信息.

![](../../assets/http/shakeHands2.png)

1. `client >> server`: 这里有个标志位 `SYN = 1` 表示这是一个创建请求的数据包，服务端接收到之后就知道有个客户端要和他创建连接，创建连接之后呢就会开启 TCP 的一个端口，返回给客户端数据包
2. `server >> client`: `SYN = 1` 且 `Seq = Y` 且 `ACK = X + 1` 的数据包， 表示服务端已经允许客户端打开去创建 tcp 连接 接着
3. `client >> server`: `SYN = 0` 且 `Seq = Z` 且 `ACK = Y + 1`

::: tip 三次握手的意义
为了防止服务端 开启一些无用的连接 ，因为网络传输是有延时的，因为中间隔着光纤、代理服务器等进行传输，传输过程当中，客户端发送 `SYN = 1` 创建连接的请求， 如果服务端直接返回数据，数据包可能因为网络传输的原因丢失。

那么客户端就一直没有接收到服务器返回的数据，这时候服务端是不知道客户端接收到了数据的， 并且没有得到客户端的信息来确认或者关闭这次请求，服务端就开着端口等着客户端来发送实际的请求数据，所以我们需要三次握手确认这个过程， 让客户端和服务器能及时的察觉传输过程遇到的问题。
:::

### 第一次握手:建立连接，等待服务器确认

**客户端创建一个新连接 `SYN = 1` 且 `Seq = X`>> 服务端**

![](../../assets/http/shake-hand-1.png)

- `Seq = X`: X 即客户端的序列
- `SYN = 1`

### 第二次握手:服务器收到请求后确认联机

**服务端发回确认包 客户端创建一个新连接 `SYN = 1` 且 `Seq = Y` 且 `ACK = X + 1` >> 客户端**

![](../../assets/http/shake-hand-2.png)

### 第三次握手:检查 ACK 是否正确, 若正确则建立连接。

**客户端发回确认包 客户端创建一个新连接 `SYN = 0` 且 `Seq = Z` 且 `ACK = Y + 1` >> 服务端**

![](../../assets/http/shake-hand-3.png)

1. `SYN = 0`: 这不再是一个新的连接
2. `ACK = Y + 1`: 确认服务器给我发的序号
3. `标志位 ack = 1`: 确认有效
