---
title: TCP 四次挥手等待 2MSL 的意义？
date: 2020-06-10 18:00:56
---

## 2MSL 等待的意义

> `MSL` 是 Maximum Segment Lifetime 英文的缩写，中文可以译为“报文最大生存时间”，他是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。

详见 [再谈 TCP 的三次握手和四次挥手](../tcp-connection.md)

先看下四次挥手的过程

1. 客户端给服务端发送 `FIN` 报文，告诉服务端我要关闭请求了。然后客户端进入 `FIN_WAIT` 状态.
2. 服务端收到后，立马发个 `ACK` 报文给客户端，表示我确认收到你的报文。
3. 此时服务端可能还有一些数据传输要处理，确认处理了完毕后才发送 `FIN` 给客户端，表示我也要请求关闭了。超时之后没回应的话服务端就重新再发送 `FIN` 报文
4. 客户端收到后回复 `ACK` 报文，表示好的收到了，你快关闭把。服务端收到后就关闭了，而客户端等待 2MSL 时间后就关闭连接了。

<blockquote class='box'>

1. 如果因为网络原因导致第四次挥手，也即服务端收不到 `ACK` 报文，此时服务端无法确认客户端收到了第三次挥手发送的 `FIN` 报文，超时后会重新发送。
   而此时客户端已经关闭的话，`FIN` 找不到对应的连接， 会导致连接错乱和带宽的浪费。
2. 如果前一次的连接某些数据滞留在网络中，这些延迟数据在建立新连接后到达 Client 端，TCP 可能以为延迟的数据就是新的连接，新连接就会接收到脏数据，这样就会导致**数据包混乱**。所以 TCP 连接需要在 TIME_WAIT 状态等待 2MSL，才能**保证本次连接的所有数据在网络中消失**。

总结：预防连接错乱和数据包混乱

</blockquote>

## 挥手为什么需要四次？

<blockquote class='box'>

因为当服务端收到客户端的 SYN 连接请求报文后，可以直接发送 SYN+ACK 报文。其中 ACK 报文是用来应答的，SYN 报文是用来同步的。

但是关闭连接时，当服务端收到 FIN 报文时，很可能并不会立即关闭 SOCKET，所以只能先回复一个 ACK 报文，告诉客户端，"你发的 FIN 报文我收到了"。

只有等到我服务端所有的报文都发送完了，我才能发送 FIN 报文，因此不能一起发送。故需要四次挥手。

</blockquote>
