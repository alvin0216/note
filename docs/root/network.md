---
title: network 面板分析
date: 2020-07-02 22:03:47
---

## 网络面板

![](https://gitee.com/alvin0216/cdn/raw/master/img/browser/chrome/network.png)

## 查看 Timing

每个资源的详细请求信息我们都可以在详细列表中找到。要分析单个资源请求时间线，需要借助到 `Chrome` 的 `timing`， 也即**时间线面板**。

先看看 HTTP 的请求流程：

![](https://gitee.com/alvin0216/cdn/raw/master/img/browser/chrome/http.png)

发起一个 HTTP 请求之后，浏览器首先查找缓存，如果缓存没有命中，那么继续发起 DNS 请求获取 IP 地址，然后利用 IP 地址和服务器端建立 TCP 连接，再发送 HTTP 请求，等待服务器响应；不过，如果服务器响应头中包含了重定向的信息，那么整个流程就需要重新再走一遍。这就是在浏览器中一个 HTTP 请求的基础流程。

那详细列表中是如何表示出这个流程的呢？这就要重点看下时间线面板了, 查看的方式一般有两种：

1. 选中 http 包，在右侧就有 timing 信息
2. 鼠标移动到 http 包且当前行是 Waterfail （在上图的 Size -> Time -> Waterfail）时，悬停显示

<div class='flex-img'>

![](https://gitee.com/alvin0216/cdn/raw/master/img/browser/chrome/timing.png)
![](https://gitee.com/alvin0216/cdn/raw/master/img/browser/chrome/timing2.png)

</div>

上面两个都是单个请求的 timing，DOMContentLoaded 代表的是该文件下载完成。

那面板中这各项到底是什么含义呢？

### Resource Scheduling

**第一个是 `Queuing`**，也就是排队的意思，当浏览器发起一个请求的时候，会有很多原因导致该请求不能被立即执行，而是需要排队等待。导致请求处于排队状态的原因有很多。

- 首先，页面中的资源是有优先级的，比如 CSS、HTML、JavaScript 等都是页面中的核心文件，所以优先级最高；而图片、视频、音频这类资源就不是核心资源，优先级就比较低。通常当后者遇到前者时，就需要“让路”，进入待排队状态。
- 其次，浏览器会为每个域名最多维护 6 个 TCP 连接，也即并发连接。如果发起一个 HTTP 请求时，这 6 个 TCP 连接都处于忙碌状态，那么这个请求就会处于排队状态。
- 最后，网络进程在为数据分配磁盘空间时，新的 HTTP 请求也需要短暂地等待磁盘分配结束。

### Connection Start

等待排队完成之后，就要进入发起连接的状态了。不过在发起连接之前，还有一些原因可能导致连接过程被推迟，这个推迟就表现在面板中的 `Stalled` 上，它表示停滞的意思。

接下来，就到了 `Initial connection/SSL` 阶段了也就是和服务器建立连接的阶段，这包括了建立 TCP 连接所花费的时间；如果使用 HTTPS，还需要经历 [SSL 握手](../http/https/tsl.md)时间，这个过程主要是用来协商一些加密信息的。

### Request sent

和服务器建立好连接之后，网络进程会准备请求数据，并将其发送给网络，这就是 **Request sent 阶段**。通常这个阶段非常快，因为只需要把浏览器缓冲区的数据发送出去就结束了，并不需要判断服务器是否接收到了，所以这个时间通常不到 1 毫秒。

数据发送出去了，接下来就是等待接收服务器第一个字节的数据，这个阶段称为 `Waiting (TTFB)`， 通常也称为“**第一字节时间**”。 TTFB 是反映服务端响应速度的重要指标，对服务器来说，TTFB 时间越短，就说明服务器响应越快。

接收到第一个字节之后，进入陆续接收完整数据的阶段，也就是 **Content Download 阶段**，这意味着从第一字节时间到接收到全部响应数据所用的时间。

## 优化时间线上耗时项

了解了时间线面板上的各项含义之后，我们就可以根据这个请求的时间线来实现相关的优化操作了。

### 排队（Queuing）时间过久

排队时间过久，大概率是因为浏览器提供的并发连接数所限制。Chrome 一个域名下执行 6 个并发数。解决方法如下

- **域名分片**： 1 个站点下面的资源放在多个域名下面，比如放到 3 个域名下面，这样就可以同时支持 18 个连接了。
- **升级到 HTTP 2**: [http2](../http/http2/http2.md) 对报文进行了头部压缩和二进制分帧，以流的方式无序传输，流是可并发的彼此不依赖，所以 http 请求没有了队头阻塞问题。

### 第一字节时间（TTFB）时间过久

这可能的原因有如下：

- **服务器生成页面数据的时间过久。**。对于动态网页来说，服务器收到用户打开一个页面的请求时，首先要从数据库中读取该页面需要的数据，然后把这些数据传入到模板中，模板渲染后，再返回给用户。服务器在处理这个数据的过程中，可能某个环节会出问题。
- **网络的原因**。比如使用了低带宽的服务器，或者本来用的是电信的服务器，可联通的网络用户要来访问你的服务器，这样也会拖慢网速。
- **发送请求头时带上了多余的用户信息**。比如一些不必要的 Cookie 信息，服务器接收到这些 Cookie 信息之后可能需要对每一项都做处理，这样就加大了服务器的处理时长。

对于这三种问题，你要有针对性地出一些解决方案。面对第一种服务器的问题，你可以想办法去提高服务器的处理速度，比如通过增加各种缓存的技术；针对第二种网络问题，你可以使用 CDN 来缓存一些静态文件；至于第三种，你在发送请求时就去尽可能地减少一些不必要的 Cookie 数据信息。

### Content Download 时间过久

如果单个请求的 Content Download 花费了大量时间，有可能是字节数太多的原因导致的。这时候你就需要减少文件大小，比如压缩、去掉源码中不必要的注释等方法。

## 下载概要

> 重点关注下 `DOMContentLoaded` 和 `Load` 两个事件，以及这两个事件的完成时间。

- `DOMContentLoaded`: 这个事件发生后，说明页面已经构建好 DOM 了，这意味着构建 DOM 所需要的 HTML 文件、JavaScript 文件、CSS 文件都已经下载完成了。
- `Load`: 说明浏览器已经加载了所有的资源（图像、样式表等）。

通过下载信息概要面板，你可以查看触发这两个事件所花费的时间。

![](https://gitee.com/alvin0216/cdn/raw/master/img/browser/chrome/network-summary.png)

参考 [Chrome 开发者工具：利用网络面板做性能分析](https://time.geekbang.org/column/article/138844?code=NiCoaK-xsW6tErzSr6ZGB3jwgne3Pqg7v1UPGf9ApOI)
