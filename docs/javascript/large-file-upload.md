---
title: 大文件上传和断点续传
date: 2020-04-13 15:57:04
---

## 前言

如果太大的文件，比如一个视频 1g 2g 或者更大， 直接上传的方式可能会出现**链接超时**的情况，而且也会**超过服务端允许上传文件的大小限制**，所以解决这个问题我们可以将文件进行分片上传，每次只上传很小的一部分 比如 `2M`。

<Badge text="前端" type="success"/>

---

切片上传大文件的核心则是利用 [Blob.prototype.slice](./blob.md#blob-prototype-slice), 和数组的 `slice` 方法相似，调用的 `slice` 方法可以返回`原文件的某个切片`

这样我们就可以根据预先设置好的切片最大数量将文件切分为一个个切片，然后借助 `http` 的可并发性，同时上传多个切片，这样从原本传一个大文件，变成了同时传多个小的文件切片，可以大大减少上传时间

另外由于是并发，传输到服务端的顺序可能会发生变化，所以我们还需要给每个切片记录顺序

<Badge text="服务端" type="warning"/>

---

服务端需要负责接受这些切片，并在接收到所有切片后`合并切片`

这里又引伸出两个问题

1. 何时合并切片，即切片什么时候传输完成
2. 如何合并切片

第一个问题需要前端进行配合，前端在每个切片中都携带切片最大数量的信息，当服务端接受到这个数量的切片时自动合并，也可以额外发一个请求主动通知服务端进行切片的合并

第二个问题，具体如何合并切片呢？这里可以使用 `nodejs` 的 读写流（`readStream/writeStream`），将所有切片的流传输到最终文件的流里

## 参考文章

- [字节跳动面试官：请你实现一个大文件上传和断点续传](https://juejin.im/post/5dff8a26e51d4558105420ed)
- [写给新手前端的各种文件上传攻略，从小图片到大文件断点续传](https://juejin.im/post/5da14778f265da5bb628e590)
- [字节跳动面试官，我也实现了大文件上传和断点续传](https://juejin.im/post/5e367f6951882520ea398ef6)
