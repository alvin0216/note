---
title: 浏览器多进程
date: 2020-06-11 23:43:42
---

## 单个页面卡死最终崩溃导致所有页面崩溃的原因？

<blockquote class='box'>

**同一站点（协议+根域名一样）会复用父页面的渲染流程**。具体可以看[导航流程之准备渲染进程](../macro/url-to-display.md#准备渲染进程)

Chrome 的默认策略是，每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫 `process-per-site-instance`。

直白的讲，就是如果几个页面符合同一站点，那么他们将被分配到一个渲染进程里面去。

所以，这种情况下，一个页面崩溃了，会导致同一站点的页面同时崩溃，因为他们使用了同一个渲染进程。

为什么要让他们跑在一个进程里面呢？

因为在一个渲染进程里面，他们就会共享 JS 的执行环境，也就是说 A 页面可以直接在 B 页面中执行脚本。因为是同一家的站点，所以是有这个需求的。

</blockquote>

## 单进程浏览器开多个页面，渲染线程也只有一个吗？

<blockquote class='box'>

我们从 IE6 开始讲起，IE6 时代，浏览器是单进程的，所有页面也都是运行在一个主线程中的，当时 IE6 就是这样设计，而且此时的 IE6 是单标签，也就是说一个页面一个窗口。

这时候，国内有很多国产浏览器，都是基于 IE6 来二次开发的，而 IE6 原生架构就是所有页面跑在单线程里面的，意味着，所有的页面都共享着同一套 JavaScript 运行环境，同样，对于存储 Cookie 也都是在一个线程里面操作的。

而且这些国产浏览器由于需要，都采用多标签的形式，所以其中的一个标签页面的卡顿都会影响到整个浏览器。

基于卡顿的原因，国内浏览器就开始尝试支持页面多线程，也就是让部分页面运行在单独的线程之中，运行在单独的线程之中，意味着每个线程拥有单独的 JavaScript 执行环境，和 Cookie 环境，这时候问题就来了：

比如 A 站点页面登陆一个网站，保存了一些 Cookie 数据到磁盘上，再在当前线程环境中保存部分 Session 数据，由于 Session 是不需要保存到硬盘上的，所以 Session 只会保存在当前的线程环境中。这时候再打开另外一个 A 站点的页面，假设这个页面在另外一个线程中里面，那么它首先读取硬盘上的 Cookie 信息，但是，由于 Session 信息是保存在另外一个线程里面的，无法直接读取，这样就要实现一个 Session 同步的问题，由于 IE 并没有源代码，所以实现起来非常空难，国内浏览器花了好长一点时间才解决这个问题的。

Session 问题解决了，但是假死的问题依然有，因为进程内使用了一个窗口，这个窗口是依附到浏览器主窗口之上的，所以他们公用一套消息循环机制，消息循环我们后面会详细地讲，这也就意味这一个窗口如果卡死了。也会导致整个浏览器的卡死。

国产浏览器又出了一招，就是把页面做成一个单独的弹窗，如果这个页面卡死了，就把这个弹窗给隐藏掉。

这里还要提一下为什么 Chrome 中的一个页面假死不会影响到主窗口呢？
**这是因为 chrome 输出的实际上图片，然后浏览器端把图片贴到自己的窗口上去，在 Chrome 的渲染进程内，并没有一个渲染窗口，输出的只是图片，如果卡住了，顶多图片不更新了。**

国产浏览器这一套技术花了四五年时间，等这套技术差不多成熟时，Chrome 发布了 :(

</blockquote>

## 为什么单进程浏览器当时不可以采用安全沙箱？

<blockquote class='box'>

如果一个进程使用了安全沙箱之后，该进程对于操作系统的权限就会受到限制，比如不能对一些位置的文件进行读写操作，而这些权限浏览器主进程所需要的，所以安全沙箱是不能应用到浏览器主进程之上的。

</blockquote>

## webkit 和 chrome 是啥关系？

<blockquote class='box'>

webkit 渲染引擎，复杂把 html，css，js 渲染成页面。

Chrome 刚开始采用了 webkit 作为其渲染引擎，不过后面又基于 webkit 重新造了 blink 引擎。

</blockquote>

## 在同一个请求过程中，tcp 跟 udp 是二选一吧？他们会都用吗？

<blockquote class='box'>
是的
</blockquote>

## 同一站点共用一个渲染进程，那假设有 2 个标签页是同一站点，我在 A 标签页面写个死循环，导致页面卡死，B 页面是否也是卡死了呢？

<blockquote class='box'>

事件循环机制了

多个页面公用一个渲染进程，也就意味着多个页面公用同一个主线程，所有页面的任务都是在同一个主线程上执行，这些任务包括渲染流程，JavaScript 执行，用户交互的事件的响应等等，@@@但是@@@ 如果一个标签页里面执行一个死循环，那么意味着该 JavaScript 代码会一直霸占主线程，这样就导致了其它的页面无法使用该主线程，从而让所有页面都失去响应！

</blockquote>
