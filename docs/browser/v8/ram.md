---
title: 栈空间和堆空间：数据是如何存储的？
date: 2020-06-16 20:31:29
---

**基本类型的数据值都是直接保存在“栈”中的，引用类型的值是存放在“堆”中的。**

JavaScript 中的数据类型一种有 8 种，它们分别是：

| 类型        | 描述                                                               |
| ----------- | ------------------------------------------------------------------ |
| `Boolean`   | true/false                                                         |
| `Null`      | null                                                               |
| `Undefined` | 没有赋值的变量默认值 或者变量提升的默认值 undefined                |
| `Number`    | 数字                                                               |
| `BigInt`    | 使用 BigInt 即使超出 Number 安全整数范围限制，也可以安全存储和操作 |
| `String`    | 代表文本字符串                                                     |
| `Symbol`    | 符合类型唯一且不可修改                                             |
| `Object`    | 对象                                                               |

- 基本类型：`Boolean`, `Null`, `Undefined`, `Number`, `BigInt`, `String`, `Symbol`
- 引用类型：`Object` 如 Array、Date、RegExp、Function...

堆栈是如何存储数据的，先看一段代码：

```js
function foo() {
  var a = '极客时间'
  var b = a
  var c = { name: '极客时间' }
  var d = c
}
foo()
```

当执行一段代码时，需要先编译，并创建执行上下文, 执行代码，分别是 `var a = '极客时间'` a 入栈. `var b = a` b 入栈... 如图：

![](https://gitee.com/alvin0216/cdn/raw/master/img/browser/v8/1.png)

原始类型的赋值会完整复制变量值，而引用类型的赋值是复制引用地址。 所以 d=c 的操作就是把 c 的引用地址赋值给 d。两者指向同个对象，所以：

```js
c.name = 'change'
console.log(d.name) // change
```

修改了 c 的属性值，d 也跟着改了。当然，你可能会问:

为什么一定要分“堆”和“栈”两个存储空间呢？所有数据直接存放在“栈”中不就可以了吗？

首先 JavaScript 引擎需要用栈来维护程序执行期间上下文的状态，它的功能除了保存变量之外，还有创建并切换函数执行上下文的功能。

如果栈空间大了话，所有的数据都存放在栈空间里面，那么会影响到上下文切换的效率，进而又影响到整个程序的执行效率。比如文中的 foo 函数执行结束了，JavaScript 引擎需要离开当前的执行上下文，只需要将指针下移到上个执行上下文的地址就可以了，foo 函数执行上下文栈区空间全部回收，具体过程你可以参考下图：

![](https://gitee.com/alvin0216/cdn/raw/master/img/browser/v8/2.png)

如果采用栈来存储相对基本类型更加复杂的对象数据，那么切换上下文的开销将变得巨大！

所以通常情况下，**栈空间都不会设置太大，主要用来存放一些原始类型的小数据**。而引用类型的数据占用的空间都比较大，所以这一类数据会被存放到堆中，**堆空间很大，能存放很多大的数据**，不过缺点是分配内存和回收内存都会占用一定的时间。

不过堆内存虽然空间大，能存放大量的数据，但与此同时垃圾内存的回收会带来更大的开销，下一篇就来分析一下堆内存到底是如何进行垃圾回收并进行优化的。

参考 [V8 引擎如何进行垃圾内存的回收？](http://47.98.159.95/my_blog/js-v8/002.html)
