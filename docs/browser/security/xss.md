---
title: 跨站脚本攻击 XSS
date: 2020-06-09 18:23:09
---

## XSS 跨站脚本攻击

`XSS` “跨站脚本”。**XSS 攻击是指黑客往 HTML 文件中或者 DOM 中注入恶意脚本**，从而在用户浏览页面时利用注入的恶意脚本对用户实施攻击的一种手段。

恶意脚本都能做哪些事情：

- 可以**窃取 Cookie 信息**。恶意 JavaScript 可以通过“`document.cookie`”获取 Cookie 信息，然后通过 XMLHttpRequest 或者 Fetch 加上 CORS 功能将数据发送给恶意服务器；恶意服务器拿到用户的 Cookie 信息之后，就可以在其他电脑上模拟用户的登录，然后进行转账等操作。
- 可以**监听用户行为**。恶意 JavaScript 可以使用“`addEventListener`”接口来监听键盘事件，比如可以获取用户输入的信用卡等信息，将其发送到恶意服务器。黑客掌握了这些信息之后，又可以做很多违法的事情。
- 可以通过**修改 DOM 伪造假的登录窗口**，用来欺骗用户输入用户名和密码等信息。
- 还**可以在页面内生成浮窗广告**，这些广告会严重地影响用户体验。

---

笔者曾经遇到 `XSS` 攻击：自建博客网站 [react-blog](https://github.com/alvin0216/react-blog) 中允许评论且支持 `markdown` 语法，也即会转义为 `html`. 由于没做处理我可以在评论框里做 XSS 攻击的一些事情：

```html
<script>
  window.location.href = 'https://baidu.com'
</script>
```

自然而然转义为 `html`, 那么只要访问这个网站，就会被跳转到百度网页。

---

假如嵌入的脚本是读取 cookie 然后发送到黑客服务器，那么很可能泄露个人信息。

那么如何处理 XSS 呢？

## 阻止 XSS 攻击

### 服务器对输入脚本进行过滤或转码

我们都可以在服务器端/客户端将一些关键的字符进行转码，比如最典型的：

```html
code:
<script>
  alert('你被xss攻击了')
</script>
```

这段代码过滤后，只留下了：

```html
code:
```

这样，当用户再次请求该页面时，由于 `script` 标签的内容都被过滤了，所以这段脚本在客户端是不可能被执行的。

除了过滤之外，服务器还可以对这些内容进行转码，还是上面那段代码，经过转码之后，效果如下所示：

```html
code:&lt;script&gt;alert(&#39;你被xss攻击了&#39;)&lt;/script&gt;
```

### 充分利用 CSP

虽然在服务器端执行过滤或者转码可以阻止 XSS 攻击的发生，但完全依靠服务器端依然是不够的，我们还需要把 CSP 等策略充分地利用起来，以降低 XSS 攻击带来的风险和后果。

实施严格的 CSP 可以有效地防范 XSS 攻击，具体来讲 CSP 有如下几个功能：

- 限制加载其他域下的资源文件，这样即使黑客插入了一个 JavaScript 文件，这个 JavaScript 文件也是无法被加载的；
- 禁止向第三方域提交数据，这样用户数据也不会外泄；
- 禁止执行内联脚本和未授权的脚本；
- 还提供了上报机制，这样可以帮助我们尽快发现有哪些 XSS 攻击，以便尽快修复问题。

### 使用 HttpOnly 属性

由于很多 XSS 攻击都是来盗用 Cookie 的，因此还可以通过使用 HttpOnly 属性来保护我们 Cookie 的安全。
