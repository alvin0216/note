(window.webpackJsonp=window.webpackJsonp||[]).push([[117],{680:function(v,_,t){"use strict";t.r(_);var e=t(6),s=Object(e.a)({},(function(){var v=this,_=v.$createElement,t=v._self._c||_;return t("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[t("p",[v._v("TCP 的三次握手，也是需要确认双方的两样能力: 发送的能力和接收的能力。于是便会有下面的三次握手的过程:")]),v._v(" "),t("p",[t("img",{attrs:{src:"https://alvin-cdn.oss-cn-shenzhen.aliyuncs.com/images/shake-hand.png",alt:""}})]),v._v(" "),t("h2",{attrs:{id:"握手过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#握手过程"}},[v._v("#")]),v._v(" 握手过程")]),v._v(" "),t("p",[v._v("刚开始客户端处于 "),t("code",[v._v("Closed")]),v._v(" 的状态，服务端处于 "),t("code",[v._v("Listen")]),v._v(" 状态。 进行三次握手：")]),v._v(" "),t("table",[t("thead",[t("tr",[t("th",[v._v("握手")]),v._v(" "),t("th",[v._v("描述")])])]),v._v(" "),t("tbody",[t("tr",[t("td",[v._v("1️⃣")]),v._v(" "),t("td",[v._v("客户端给服务端发一个 "),t("code",[v._v("SYN")]),v._v(" 报文，并指明客户端的初始化序列号 ISN(c)。此时客户端处于 "),t("code",[v._v("SYN_SEND")]),v._v(" 状态。")])]),v._v(" "),t("tr",[t("td",[v._v("2️⃣")]),v._v(" "),t("td",[v._v("服务器收到客户端的 SYN 报文之后，会以自己的 "),t("code",[v._v("SYN + ACK")]),v._v(" 报文作为应答，并且也是指定了自己的初始化序列号 ISN(s)。 同时会把客户端的 ISN + 1 作为 ACK 的值，表示自己已经收到了客户端的 SYN，此时服务器处于 "),t("code",[v._v("SYN_REVD")]),v._v(" 的状态。")])]),v._v(" "),t("tr",[t("td",[v._v("3️⃣")]),v._v(" "),t("td",[v._v("客户端收到 SYN 报文之后，会发送一个 "),t("code",[v._v("ACK")]),v._v(" 报文，当然，也是一样把服务器的 ISN + 1 作为 ACK 的值，表示已经收到了服务端的 SYN 报文，此时客户端处于 "),t("code",[v._v("ESTABLISHED")]),v._v(" 状态。服务器收到 ACK 报文之后，也处于 "),t("code",[v._v("ESTABLISHED")]),v._v(" 状态，此时，双方已建立起了连接。")])])])]),v._v(" "),t("p",[v._v("从图中可以看出，SYN 是需要消耗一个序列号的，下次发送对应的 ACK 序列号要加 1，为什么呢？只需要记住一个规则:")]),v._v(" "),t("p",[t("strong",[v._v("凡是需要对端确认的，一定消耗 TCP 报文的序列号。")])]),v._v(" "),t("p",[v._v("SYN 需要对端的确认， 而 ACK 并不需要，因此 SYN 消耗一个序列号而 ACK 不需要。")]),v._v(" "),t("h2",{attrs:{id:"为什么需要三次握手-两次不行吗"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要三次握手-两次不行吗"}},[v._v("#")]),v._v(" 为什么需要三次握手，两次不行吗？")]),v._v(" "),t("p",[v._v("试想如果是用两次握手，则会出现下面这种情况：")]),v._v(" "),t("p",[v._v("如果是两次，你现在发了 SYN 报文想握手，但"),t("strong",[v._v("是这个包滞留在了当前的网络中")]),v._v("迟迟没有到达，TCP 以为这是丢了包，于是重传，两次握手建立好了连接。")]),v._v(" "),t("p",[v._v("看似没有问题，但是连接关闭后，如果这个滞留在网路中的包到达了服务端呢？这时候由于是两次握手，服务端只要接收到然后发送相应的数据包，就默认建立连接，但是现在客户端已经断开了。")]),v._v(" "),t("p",[v._v("看到问题的吧，这就带来了连接资源的浪费。")]),v._v(" "),t("h2",{attrs:{id:"三次握手过程中可以携带数据吗"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三次握手过程中可以携带数据吗"}},[v._v("#")]),v._v(" 三次握手过程中可以携带数据吗？")]),v._v(" "),t("p",[t("strong",[v._v("第三次握手的时候，可以携带。前两次握手不能携带数据。")])]),v._v(" "),t("p",[v._v("如果前两次握手能够携带数据，那么一旦有人想攻击服务器，那么他只需要在第一次握手中的 SYN 报文中放大量数据，那么服务器势必会消耗更多的时间和内存空间去处理这些数据，增大了服务器被攻击的风险。")]),v._v(" "),t("p",[v._v("第三次握手的时候，客户端已经处于 "),t("code",[v._v("ESTABLISHED")]),v._v(" 状态，并且已经能够确认服务器的接收、发送能力正常，这个时候相对安全了，可以携带数据。")]),v._v(" "),t("h2",{attrs:{id:"同时打开会怎样"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#同时打开会怎样"}},[v._v("#")]),v._v(" 同时打开会怎样？")]),v._v(" "),t("p",[v._v("如果双方同时发 "),t("code",[v._v("SYN")]),v._v(" 报文，状态变化会是怎样的呢？")]),v._v(" "),t("p",[v._v("这是一个可能会发生的情况。")]),v._v(" "),t("p",[v._v("状态变迁如下:")]),v._v(" "),t("img",{attrs:{className:"small",alt:"",src:"https://alvin-cdn.oss-cn-shenzhen.aliyuncs.com/images/tcp-connection.png"}}),v._v(" "),t("p",[v._v("在发送方给接收方发 "),t("code",[v._v("SYN")]),v._v(" 报文的同时，接收方也给发送方发 "),t("code",[v._v("SYN")]),v._v(" 报文，两个人刚上了!")]),v._v(" "),t("p",[v._v("发完 SYN，两者的状态都变为 "),t("code",[v._v("SYN-SENT")]),v._v("。")]),v._v(" "),t("p",[v._v("在各自收到对方的 "),t("code",[v._v("SYN")]),v._v(" 后，两者状态都变为 "),t("code",[v._v("SYN-REVD")]),v._v("。")]),v._v(" "),t("p",[v._v("接着会回复对应的 "),t("code",[v._v("ACK + SYN")]),v._v("，这个报文在对方接收之后，两者状态一起变为 "),t("code",[v._v("ESTABLISHED")]),v._v("。")]),v._v(" "),t("p",[v._v("这就是同时打开情况下的状态变迁。")])])}),[],!1,null,null,null);_.default=s.exports}}]);