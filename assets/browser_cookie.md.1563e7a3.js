import{_ as s,o,c as a,N as n}from"./chunks/framework.208f6f3f.js";const A=JSON.parse('{"title":"Cookie","description":"","frontmatter":{"title":"Cookie","date":"2020-06-10T16:01:15.000Z","sidebar":"auto","tags":["浏览器","cookie"],"categories":["浏览器"]},"headers":[],"relativePath":"browser/cookie.md","lastUpdated":1681197872000}'),l={name:"browser/cookie.md"},p=n(`<ul><li><a href="https://juejin.cn/post/6844904115080790023" target="_blank" rel="noreferrer">看完这篇 Session、Cookie、Token，和面试官扯皮就没问题了</a></li><li><a href="https://cloud.tencent.com/developer/article/1751237" target="_blank" rel="noreferrer">概念区分，什么是跨站，什么是跨域</a></li><li><a href="https://juejin.cn/post/6844904095271288840" target="_blank" rel="noreferrer">当 CORS 遇到 SameSite</a></li><li><a href="https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html" target="_blank" rel="noreferrer">阮一峰：Cookie 的 SameSite 属性</a></li><li><a href="https://juejin.cn/post/6844904128557105166" target="_blank" rel="noreferrer">✨ 当浏览器全面禁用三方 Cookie</a></li><li><a href="https://www.youtube.com/watch?v=lrNwwcA9SKs" target="_blank" rel="noreferrer">✨ Chrome 80+以後的第三方 cookie 政策</a></li></ul><h2 id="什么是同站-跨站-第三方-cookie" tabindex="-1">什么是同站（跨站），第三方 cookie <a class="header-anchor" href="#什么是同站-跨站-第三方-cookie" aria-label="Permalink to &quot;什么是同站（跨站），第三方 cookie&quot;">​</a></h2><ul><li>跨域 cross-orgin：老生常谈，协议、域名、端口有一个不一样就跨域了</li><li>同站 cross-site：Cookie 与此息息相关，Cookie 实际上遵守的是“同站”策略，同站的 <code>cookie</code> 可以共享.</li></ul><blockquote><p><strong>只要两个 URL 的 eTLD+1 相同即是同站, 也即有效顶级域名+二级域名</strong></p></blockquote><ul><li><code>eTLD</code>: 即 <code>effective top-level domain</code> (有效顶级域)。</li><li>公共后缀列表: <a href="https://publicsuffix.org/" target="_blank" rel="noreferrer">Public Suffix List（PSL）</a></li></ul><table><thead><tr><th>URL</th><th>是否同站</th><th>理由</th></tr></thead><tbody><tr><td>sugarat.top</td><td>✅</td><td>eTLD+1 一致</td></tr><tr><td>ep.sugarat.top</td><td>✅</td><td>eTLD+1 一致</td></tr><tr><td>ep.sugarat.top:8080</td><td>✅</td><td>eTLD+1 一致</td></tr><tr><td>baidu.com</td><td>❌</td><td>eTLD 不一致</td></tr></tbody></table><p>举个例子：<code>web.alvin.com</code> 与 <code>service.alvin.com</code> 具有相同的二级域名，可以看作是同站不同源(same-site, cross-origin)。但，<code>web.github.io</code> 与 <code>service.github.io</code> 则是不同的站点不同的源(cross-site, cross-origin)，因为 github.io 属于公共后缀（<a href="https://github.com/publicsuffix/list" target="_blank" rel="noreferrer">Public Suffix</a>）。</p><p>第三方 cookie 的概念其实很简单，个人理解：同站内共享的 cookie ，都是第一方、其他例如跨域等产生的 cookie 属于第三方 cookie。</p><p>chrome 80+ 版本后默认 sameSite 为 <code>lax</code>, 也就是默认大部分第三方 cookie 无法被使用啦。</p><h2 id="cookie-追踪用户行为-代码示例" tabindex="-1">Cookie 追踪用户行为，代码示例 <a class="header-anchor" href="#cookie-追踪用户行为-代码示例" aria-label="Permalink to &quot;Cookie 追踪用户行为，代码示例&quot;">​</a></h2><p>了解 cookie 的一个重要的用法，比如我在百度搜索了喜欢的水果苹果，那么在水果购买网站通过 cookie 拿到用户喜好，自动推荐苹果的相关链接。</p><p>演示版本 chrome 80+，所以要禁用 samesite 属性才行，否则第三方 cookie 无法被携带！</p><p><strong>index.html</strong></p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">h1</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">你的喜好</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">h1</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">onclick</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#82AAFF;">sendFav</span><span style="color:#C3E88D;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">apple</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">apple</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">onclick</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#82AAFF;">sendFav</span><span style="color:#C3E88D;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">banana</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">banana</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">sendFav</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">item</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">xhr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XMLHttpRequest</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">GET</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">http://localhost:3000/api?fav=</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">item</span><span style="color:#89DDFF;">}\`</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">withCredentials</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p><strong>server.js</strong></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> express </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">express</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> app </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">express</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> router </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> express</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Router</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> port </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3000</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">router</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">hello world!, cookie: </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">req</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">headers</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">cookie</span><span style="color:#89DDFF;">}\`</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">router</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/api</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">req</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">header</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Access-Control-Allow-Origin</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">req</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">headers</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">origin</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">header</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Access-Control-Allow-Credentials</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cookie</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fav</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">req</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">query</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">fav</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    secure</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">//</span></span>
<span class="line"><span style="color:#F07178;">    sameSite</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">none</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">json</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> status</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ok</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> router)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listen</span><span style="color:#A6ACCD;">(port</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">Example app listening at http://localhost:</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">port</span><span style="color:#89DDFF;">}\`</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>上面代码有几个注意点，</p><ol><li>xhr 携带 cookie，需要设置 <code>withCredentials = true</code>, 服务端 <code>Access-Control-Allow-Origin</code> 不能为 <code>*</code></li><li>禁用 <code>samesite</code>，使得第三方 <code>cookie</code> 得以使用，需要设置 <code>secure = true</code></li></ol><p><img src="https://alvin-cdn.oss-cn-shenzhen.aliyuncs.com/images/samesite.png" alt=""></p><h2 id="cookie-相关属性" tabindex="-1">Cookie 相关属性 <a class="header-anchor" href="#cookie-相关属性" aria-label="Permalink to &quot;Cookie 相关属性&quot;">​</a></h2><p><img src="https://alvin-cdn.oss-cn-shenzhen.aliyuncs.com/images/cookie3.png" alt=""></p><p>重点讲一下：</p><ul><li><code>httpOnly</code>: boolean，不能通过 document.cookie 访问到 cookie，有效防止 xss 攻击</li><li><code>secure</code>: true, cookie 只会在 https 和 ssl 等安全协议下传输</li><li><code>samesite</code>：第三方 cookie 的一些策略，后面讲到。</li><li><code>path</code>: 限制 cookie 的路由匹配，比如 <code>/test</code> <code>/test/aa</code>, 前者包容后者，默认是 <code>/</code>。</li><li><code>domain</code>: cookie 的 domain，比如 <code>.baidu.com</code>, 那么 <code>a.baidu.com</code>、<code>b.baidu.com</code> 可以共享。</li><li><code>expires/max-age</code>: 过期时间。</li></ul><p><strong>sameSite 属性</strong></p><ul><li><code>Strict</code>：完全禁止第三方 Cookie，跨站点时，任何情况下都不会发送 Cookie。</li><li><code>Lax</code>: <img src="https://alvin-cdn.oss-cn-shenzhen.aliyuncs.com/images/samesite-lax.png" alt=""></li><li><code>None</code>：显式关闭 <code>SameSite</code> 属性，不过，前提是必须同时设置 <code>Secure</code> 属性</li></ul><h2 id="cookie-一些概念-session" tabindex="-1">Cookie 一些概念 &amp; Session <a class="header-anchor" href="#cookie-一些概念-session" aria-label="Permalink to &quot;Cookie 一些概念 &amp; Session&quot;">​</a></h2><p>可能面试常问，这里简单列一下。</p><p><strong>1. 什么是 Cookie？</strong></p><p>HTTP 是无状态的协议（对于事务处理没有记忆能力，每次客户端和服务端会话完成时，服务端不会保存任何会话信息）：每个请求都是完全独立的，服务端无法确认当前访问者的身份信息，无法分辨上一次的请求发送者和这一次的发送者是不是同一个人。所以服务器与浏览器为了进行会话跟踪（知道是谁在访问我），就必须主动的去维护一个状态，这个状态用于告知服务端前后两个请求是否来自同一浏览器。而这个状态需要通过 cookie 或者 session 去实现。</p><p><strong>2. Cookie 设置的过程。</strong></p><p>客户端发送请求 -&gt; 服务端设置 <code>Cookie</code> -&gt; 浏览器保存 <code>Cookie</code>, 以后每次请求都带上。</p><p><strong>3. Cookie 的作用。</strong></p><ul><li>会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）</li><li>个性化设置（如用户自定义设置、主题等）</li><li>浏览器行为跟踪（如跟踪分析用户行为等）</li></ul><p><strong>4. 与 Session 的区别。</strong></p><p>首先注意。Session 是依赖于 Cookie 的，如果 Cookie 被禁用了，Session 也用不了。</p><p>客户端发送请求 -&gt; 服务端设置 <code>Cookie</code>，里面可能只有 sessionId -&gt; 浏览器保存 <code>Cookie</code>, 以后每次请求都带上。</p><p>最大区别莫过于一个是存储在浏览器端，显而易见不安全、而 Session 保存在服务端，相对安全。基于这一点，可见：</p><p>高并发的时候 Session 由于是在服务端的，所以压力大，所以简单的来说 session 一般设置失效时间较短。</p>`,38),e=[p];function t(c,r,F,D,y,i){return o(),a("div",null,e)}const d=s(l,[["render",t]]);export{A as __pageData,d as default};
