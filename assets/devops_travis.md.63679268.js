import{_ as s,o as a,c as n,N as l}from"./chunks/framework.208f6f3f.js";const F=JSON.parse('{"title":"使用 travis 进行持续集成","description":"","frontmatter":{"title":"使用 travis 进行持续集成","date":"2019-07-15T13:00:30.000Z","sidebar":"auto","tags":["travis","持续集成","前端工程化"],"categories":["前端工程化"]},"headers":[],"relativePath":"devops/travis.md","lastUpdated":1681197312000}'),p={name:"devops/travis.md"},o=l(`<h2 id="事前准备" tabindex="-1">事前准备 <a class="header-anchor" href="#事前准备" aria-label="Permalink to &quot;事前准备&quot;">​</a></h2><p>进入 <a href="https://travis-ci.com" target="_blank" rel="noreferrer">travis-ci.com</a>，登录之后 Github 的 repo 授权给 travis，按照指示来即可。</p><h2 id="部署到-github-pages" tabindex="-1">部署到 github pages <a class="header-anchor" href="#部署到-github-pages" aria-label="Permalink to &quot;部署到 github pages&quot;">​</a></h2><p>在项目根目录配置 <code>.travis.yaml</code> 配置文件，配置 <a href="https://github.com/settings/tokens" target="_blank" rel="noreferrer">github token</a> 到 travis 项目的 settings 中 作为密钥</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">language:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node_js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 指定 NodeJs 版本，也可直接设为 12</span></span>
<span class="line"><span style="color:#FFCB6B;">node_js:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">stable</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 缓存依赖</span></span>
<span class="line"><span style="color:#FFCB6B;">cache:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">directories:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node_modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 使用 yarn 安装</span></span>
<span class="line"><span style="color:#FFCB6B;">install:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yarn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 设置需要监听的分支</span></span>
<span class="line"><span style="color:#FFCB6B;">branches:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">only:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 需要执行的脚本</span></span>
<span class="line"><span style="color:#FFCB6B;">script:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yarn</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">deploy:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">provider:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pages</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">skip_cleanup:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">github_token:</span><span style="color:#A6ACCD;"> $github_token </span><span style="color:#676E95;font-style:italic;"># Set in the settings page of your repository, as a secure variable</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">keep_history:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">local_dir:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 打包的地址</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">on:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">branch:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">master</span></span>
<span class="line"></span></code></pre></div><p>push 即可看到效果</p><h2 id="配置到-centos-服务器" tabindex="-1">配置到 CentOS 服务器 <a class="header-anchor" href="#配置到-centos-服务器" aria-label="Permalink to &quot;配置到 CentOS 服务器&quot;">​</a></h2><h3 id="安装-travis" tabindex="-1">安装 travis <a class="header-anchor" href="#安装-travis" aria-label="Permalink to &quot;安装 travis&quot;">​</a></h3><p>mac 下：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 安装rvm</span></span>
<span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-sSL</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://get.rvm.io</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bash</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stable</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 安装完成后测试是否安装成功</span></span>
<span class="line"><span style="color:#FFCB6B;">rvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">version</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 安装ruby</span></span>
<span class="line"><span style="color:#FFCB6B;">rvm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ruby</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 修改镜像源</span></span>
<span class="line"><span style="color:#FFCB6B;">gem</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sources</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-l</span></span>
<span class="line"><span style="color:#FFCB6B;">gem</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sources</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">http://gems.ruby-china.org/</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--remove</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://rubygems.org/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 安装travis命令行工具</span></span>
<span class="line"><span style="color:#FFCB6B;">gem</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">travis</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 切回travis用户，执行travis命令有以下输出说明安装成功</span></span>
<span class="line"><span style="color:#FFCB6B;">travis</span></span>
<span class="line"><span style="color:#FFCB6B;">Shell</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">completion</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">not</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">installed.</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Would</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">you</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">like</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">it</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">now?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;">y</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">y.</span><span style="color:#82AAFF;">..</span></span>
<span class="line"></span></code></pre></div><h3 id="添加-ssh-链接到服务器" tabindex="-1">添加 ssh 链接到服务器 <a class="header-anchor" href="#添加-ssh-链接到服务器" aria-label="Permalink to &quot;添加 ssh 链接到服务器&quot;">​</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">ssh-keygen</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-t</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rsa</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 会生成 id_rsa 当然你也可以选择文件名...</span></span>
<span class="line"><span style="color:#FFCB6B;">ssh-copy-id</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.ssh/id_rsa.pub</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">部署服务器用户</span><span style="color:#A6ACCD;">名</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">@</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">部署服务器地</span><span style="color:#A6ACCD;">址</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#  测试一下 SSH 免密登陆</span></span>
<span class="line"><span style="color:#FFCB6B;">ssh</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">部署服务器用户</span><span style="color:#A6ACCD;">名</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">@</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">部署服务器地</span><span style="color:#A6ACCD;">址</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><h3 id="加密-ssh-密钥" tabindex="-1">加密 ssh 密钥 <a class="header-anchor" href="#加密-ssh-密钥" aria-label="Permalink to &quot;加密 ssh 密钥&quot;">​</a></h3><p>进入项目根目录，执行</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 登录 travis github token 自己拿</span></span>
<span class="line"><span style="color:#FFCB6B;">travis</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">login</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--pro</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-g</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">github-toke</span><span style="color:#A6ACCD;">n</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 将 ssh 密钥写入 .travis.yaml</span></span>
<span class="line"><span style="color:#FFCB6B;">travis</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">encrypt-file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/id_rsa</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--add</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 出现提示输入 y 之后会重新格式化 .travis.yaml 文件。</span></span>
<span class="line"></span></code></pre></div><p>登录的配置可参考 <a href="https://github.com/travis-ci/travis.rb/issues/788#issuecomment-750927765" target="_blank" rel="noreferrer">788 issue</a></p><p>打开 .travis.yaml 文件会看到多了以下内容</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">before_install:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">openssl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">aes-</span><span style="color:#F78C6C;">256</span><span style="color:#C3E88D;">-cbc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-K</span><span style="color:#A6ACCD;"> $encrypted_</span><span style="color:#A6ACCD;">******</span><span style="color:#C3E88D;">_key</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-iv</span><span style="color:#A6ACCD;"> $encrypted_</span><span style="color:#A6ACCD;">******</span><span style="color:#C3E88D;">_iv</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">-in</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">id_rsa.enc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-out</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/id_rsa</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span></span>
<span class="line"></span></code></pre></div><p>添加脚本</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">language:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node_js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 指定 NodeJs 版本，也可直接设为 12</span></span>
<span class="line"><span style="color:#FFCB6B;">node_js:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">stable</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 缓存依赖</span></span>
<span class="line"><span style="color:#FFCB6B;">cache:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">directories:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node_modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 使用 yarn 安装</span></span>
<span class="line"><span style="color:#FFCB6B;">install:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yarn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 设置需要监听的分支</span></span>
<span class="line"><span style="color:#FFCB6B;">branches:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">only:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 需要执行的脚本</span></span>
<span class="line"><span style="color:#FFCB6B;">script:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yarn</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yarn</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 添加 SSH 信任列表（服务器的IP）</span></span>
<span class="line"><span style="color:#FFCB6B;">addons:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">ssh_known_hosts:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> $remote_ip</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">before_install:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 用于 ssh 连接服务器</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">openssl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">aes-</span><span style="color:#F78C6C;">256</span><span style="color:#C3E88D;">-cbc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-K</span><span style="color:#A6ACCD;"> $encrypted_f217180e22ee_key </span><span style="color:#C3E88D;">-iv</span><span style="color:#A6ACCD;"> $encrypted_f217180e22ee_iv</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-in</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">id_rsa.enc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-out</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/id_rsa</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">chmod</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">600</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/id_rsa</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 执行部署脚本 （$remote_ip $remote_user $project_dir 在 travis 上配置即可）</span></span>
<span class="line"><span style="color:#FFCB6B;">after_success:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ssh</span><span style="color:#A6ACCD;"> $remote_user</span><span style="color:#C3E88D;">@</span><span style="color:#A6ACCD;">$remote_ip </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">StrictHostKeyChecking=no</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-rf</span><span style="color:#A6ACCD;"> $project_dir</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">scp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">StrictHostKeyChecking=no</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-r</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./public</span><span style="color:#A6ACCD;"> $remote_user</span><span style="color:#C3E88D;">@</span><span style="color:#A6ACCD;">$remote_ip</span><span style="color:#C3E88D;">:</span><span style="color:#A6ACCD;">$project_dir</span></span>
<span class="line"></span></code></pre></div><h2 id="相关文章" tabindex="-1">相关文章 <a class="header-anchor" href="#相关文章" aria-label="Permalink to &quot;相关文章&quot;">​</a></h2><ul><li><a href="https://www.bluesdream.com/blog/travis-ci-auto-deployment-the-github-project-to-remote-server.html" target="_blank" rel="noreferrer">Travis CI 自动部署 Github 项目至远程服务器</a></li><li><a href="https://juejin.cn/post/6844903570563858445" target="_blank" rel="noreferrer">Travis-CI 自动化测试并部署至自己的 CentOS 服务器</a></li><li><a href="https://juejin.cn/post/6844903808758185998" target="_blank" rel="noreferrer">用 Travis CI 打造大前端持续集成和自动化部署</a></li></ul>`,22),e=[o];function t(c,r,C,y,i,A){return a(),n("div",null,e)}const h=s(p,[["render",t]]);export{F as __pageData,h as default};
